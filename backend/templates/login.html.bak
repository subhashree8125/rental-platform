<!DOCTYPE html>
<html lang=  <div class="login-card">
    <h2>Login</h2>
    
    <!-- Tab Selection -->
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
      <button id="emailTab" onclick="switchTab('email')" style="flex: 1; padding: 10px; background: #ffcb05; color: #000; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Email/Phone</button>
      <button id="phoneTab" onclick="switchTab('phone')" style="flex: 1; padding: 10px; background: #ddd; color: #000; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Phone OTP</button>
    </div>

    <!-- Email/Phone Login Form -->
    <div id="emailLoginForm">
      <input type="text" id="identifier" placeholder="Email or Phone Number">
      <input type="password" id="password" placeholder="Password">
      <div class="options">
        <label><input type="checkbox"> Remember Me</label>
        <a href="#">Forgot Password?</a>
      </div>
      <button onclick="login()">Login</button>
    </div>

    <!-- Phone OTP Login Form -->
    <div id="phoneLoginForm" style="display: none;">
      <input type="tel" id="phoneNumber" placeholder="+91XXXXXXXXXX" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">
      <div id="recaptcha-container" style="margin-bottom: 15px;"></div>
      <button id="sendOtpBtn" onclick="sendOTP()" style="width: 100%; padding: 12px; background: #ffcb05; color: #000; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Send OTP</button>
      
      <div id="otpVerificationSection" style="display: none; margin-top: 15px;">
        <input type="text" id="otpCode" placeholder="Enter 6-digit OTP" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <button onclick="verifyOTP()" style="width: 100%; padding: 12px; background: #28a745; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Verify OTP</button>
      </div>
    </div>

    <p class="error-msg" id="errorMsg"></p>
    <p style="margin-top:15px; font-size:14px;">
      Don't have an account? 
      <a href="{{ url_for('signup_page') }}" style="color:#ffcb05; font-weight:600;">Sign Up</a>
    </p>
  </div>
</div>

<script type="module">
  // Firebase Phone Authentication
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBy6QFkyc5S20hTcaEsdUjmhy4O85roVCs",
    authDomain: "broklink-98b0d.firebaseapp.com",
    projectId: "broklink-98b0d",
    storageBucket: "broklink-98b0d.firebasestorage.app",
    messagingSenderId: "1068818827253",
    appId: "1:1068818827253:web:df071f3a9032452cac02bc",
    measurementId: "G-GB7YC6DLC1"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  auth.languageCode = 'en';

  let recaptchaVerifier = null;
  let confirmationResult = null;

  // Tab switching
  window.switchTab = function(tab) {
    if (tab === 'email') {
      document.getElementById('emailLoginForm').style.display = 'block';
      document.getElementById('phoneLoginForm').style.display = 'none';
      document.getElementById('emailTab').style.background = '#ffcb05';
      document.getElementById('phoneTab').style.background = '#ddd';
    } else {
      document.getElementById('emailLoginForm').style.display = 'none';
      document.getElementById('phoneLoginForm').style.display = 'block';
      document.getElementById('emailTab').style.background = '#ddd';
      document.getElementById('phoneTab').style.background = '#ffcb05';
      
      // Initialize reCAPTCHA when phone tab is selected
      if (!recaptchaVerifier) {
        setTimeout(() => {
          recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
            'size': 'normal',
            'callback': (response) => {
              console.log('reCAPTCHA solved');
            }
          });
          recaptchaVerifier.render();
        }, 100);
      }
    }
  }

  // Send OTP
  window.sendOTP = async function() {
    const phoneNumber = document.getElementById('phoneNumber').value.trim();
    const errorMsg = document.getElementById('errorMsg');
    
    if (!phoneNumber) {
      errorMsg.textContent = 'Please enter a phone number';
      return;
    }

    if (!phoneNumber.startsWith('+')) {
      errorMsg.textContent = 'Phone number must include country code (e.g., +91)';
      return;
    }

    try {
      document.getElementById('sendOtpBtn').disabled = true;
      document.getElementById('sendOtpBtn').textContent = 'Sending...';
      
      confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, recaptchaVerifier);
      
      document.getElementById('otpVerificationSection').style.display = 'block';
      document.getElementById('sendOtpBtn').textContent = 'OTP Sent!';
      errorMsg.textContent = '';
      errorMsg.style.color = 'green';
      errorMsg.textContent = 'OTP sent successfully! Check your phone.';
    } catch (error) {
      console.error('Error sending OTP:', error);
      errorMsg.style.color = 'red';
      errorMsg.textContent = error.message || 'Failed to send OTP. Please try again.';
      document.getElementById('sendOtpBtn').disabled = false;
      document.getElementById('sendOtpBtn').textContent = 'Send OTP';
    }
  }

  // Verify OTP
  window.verifyOTP = async function() {
    const code = document.getElementById('otpCode').value.trim();
    const errorMsg = document.getElementById('errorMsg');
    
    if (!code || code.length !== 6) {
      errorMsg.textContent = 'Please enter a valid 6-digit OTP';
      return;
    }

    try {
      const result = await confirmationResult.confirm(code);
      const idToken = await result.user.getIdToken();

      // Send token to backend for verification
      const res = await fetch("/auth/phone_login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          idToken: idToken,
          phoneNumber: result.user.phoneNumber
        })
      });

      const data = await res.json();
      
      if (data.success) {
        errorMsg.style.color = 'green';
        errorMsg.textContent = 'Login successful! Redirecting...';
        setTimeout(() => {
          window.location.href = data.redirect || '/profile';
        }, 1000);
      } else {
        errorMsg.style.color = 'red';
        errorMsg.textContent = data.message || 'Verification failed';
      }
    } catch (error) {
      console.error('Error verifying OTP:', error);
      errorMsg.style.color = 'red';
      errorMsg.textContent = 'Invalid OTP. Please try again.';
    }
  }
</script>

<script src="{{ url_for('static', filename='js/login.js') }}"></script>ta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BROKLINK - Login</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo.png') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<header>
  <div class="logo">
    <a href="{{ url_for('index') }}">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="BROKLINK LOGO">
    </a>
  </div>
</header>

<div class="container">
  <div class="left-side">
    <h1>Welcome Back</h1>
    <p id="quote-text">
      "Your next rental home is just a click away. Discover comfort, convenience, and the perfect place to call home with BROKLINK."
    </p>
  </div>

  <div class="login-card">
    <h2>Login</h2>
    <input type="text" id="identifier" placeholder="Email or Phone Number">
    <input type="password" id="password" placeholder="Password">
    <div class="options">
      <label><input type="checkbox"> Remember Me</label>
      <a href="#">Forgot Password?</a>
    </div>
    <button onclick="login()">Login</button>
    <p class="error-msg" id="errorMsg"></p>
    <p style="margin-top:15px; font-size:14px;">
      Donâ€™t have an account? 
      <a href="{{ url_for('signup_page') }}" style="color:#ffcb05; font-weight:600;">Sign Up</a>
    </p>
  </div>
</div>

<script src="{{ url_for('static', filename='js/login.js') }}"></script>
</body>
</html>
